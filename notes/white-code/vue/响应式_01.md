å“åº”å¼æ•°æ®æ ¸å¿ƒæ€è·¯

1. ç›‘æµ‹å¯¹è±¡çš„è¯»å†™

- è¯»å–å±æ€§
- è®¾ç½®å±æ€§
- æ–°å¢å±æ€§
- åˆ é™¤å±æ€§
- æ˜¯å¦å­˜åœ¨æŸä¸ªå±æ€§
- éå†å¯¹è±¡

2. æ•°æ®ä¸å‡½æ•°çš„æ˜ å°„ï¼Œå»ºç«‹ä¾èµ–å…³ç³»

- æ”¶é›†å™¨: æ”¶é›†ä¾èµ–ï¼Œå»ºç«‹æ•°æ®å’Œå‡½æ•°ä¹‹é—´çš„å…³è”å…³ç³»
- è§¦å‘å™¨: è§¦å‘ä¾èµ–ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§¦å‘ç›¸åº”çš„å‡½æ•°

## å¯¹ å¯¹è±¡çš„æ“ä½œ

### ç¬¬ä¸€æ­¥

```js
// 1. åˆ›å»ºä¸€ä¸ªå“åº”å¼æ•°æ®
import { reactive } from '../custom-reactive'

const obj = reactive({
  a: 1,
  b: 2,
  c: {
    name: 'å¼ ä¸‰'
  }
})

obj.a
```

```js
// 2. å› ä¸ºæœ‰å¥½å¤š handles æ‰€ä»¥åˆ›å»ºä¸€ä¸ª handles çš„ç›®å½•æ¥åšä¸€ä¸ªå¯¹åº”çš„å¤„ç†
export function reactive(target) {
  const proxy = new Proxy(target)
  return proxy
}

// handles/index.js

// é¦–å…ˆæ˜¯è¯»å–

// v0.1.0 ä½†æ˜¯è¿™æ ·çš„è¯æ‹¦æˆªä¸åˆ° obj.c.name å±æ€§
function getHandler(target, key) {
  console.log('ğŸš€ ~ æ‹¦æˆªçš„åŸå¯¹è±¡:', target, key)
  console.log('ğŸš€ ~ æ‹¦æˆªåˆ°çš„key:', key)
  const result = Reflect.get(target, key)
  return result
}

export default {
  get: getHandler
}
```

### ç¬¬äºŒæ­¥

å®Œå–„ä¸‹ getHandler

```js
// handles/index.js
import reactive from '../reactive'

import { isObject } from '../utils'
// v0.1.1  å¢åŠ é€’å½’å¤„ç†
// å¢åŠ  utils ç›®å½• ä¸‹åˆ¤æ–­æ˜¯å¦æ˜¯å¯¹è±¡
import reactive from '../reactive'
function getHandler(target, key) {
  const result = Reflect.get(target, key)
  return isObject(result) ? reactive(result) : result
}

export default {
  get: getHandler
}

// utils/index.js
export { default as isObject } from './isObject'

// isObject.js
export default function isObject(value) {
  return typeof value === 'object' && value !== null
}
```

### ç¬¬ä¸‰æ­¥

å»ºç«‹æ•°æ®ä¸å‡½æ•°ä¹‹é—´çš„ä¾èµ–å…³ç³»

track èƒ½æ‹¦æˆªåˆ°å¯¹åº”çš„è¡Œä¸º å°±å¯ä»¥åšäº›æ“ä½œ

```js
// æ–°å»º effect ç›®å½•ä¸‹çš„ track.js
// è¯»å– éå† æ˜¯å¦å­˜åœ¨ ç­‰åˆ¤æ–­ æ‰€ä»¥å¢åŠ ä¸€ä¸ªæšä¸¾å€¼

//  utils/index.js
export const trackTypes = {
  GET: 'get',
  ITERATE: 'iterate'
}

function track(target, type, key) {
  console.log(`ğŸš€ ~ ä»£ç†å¯¹è±¡çš„${type}è¡Œä¸ºè¢«æ‹¦æˆª, æ“ä½œçš„å±æ€§ä¸º:${key}`)
}

export default track
```

```js
// handles/index.js
import reactive from '../reactive.js'
import { isObject, trackTypes } from '../utils/index.js'

import track from '../effect/track.js'

function getHandler(target, key) {
  // console.log('ğŸš€ ~ æ‹¦æˆªçš„åŸå¯¹è±¡:', target, key)
  // console.log('ğŸš€ ~ æ‹¦æˆªåˆ°çš„key:', key)
  track(target, trackTypes.GET, key)
  const result = Reflect.get(target, key)
  return isObject(result) ? reactive(result) : result
}

export default {
  get: getHandler
}
```

### ç¬¬å››æ­¥

å®Œå–„ä¸€ä¸‹

```js
// handles/index.js
import reactive from '../reactive.js'
import { isObject, trackTypes } from '../utils/index.js'

import track from '../effect/track.js'

function getHandler(target, key) {
  // console.log('ğŸš€ ~ æ‹¦æˆªçš„åŸå¯¹è±¡:', target, key)
  // console.log('ğŸš€ ~ æ‹¦æˆªåˆ°çš„key:', key)
  track(target, trackTypes.GET, key)
  const result = Reflect.get(target, key)
  return isObject(result) ? reactive(result) : result
}

function ownKeysHandler(target) {
  track(target, trackTypes.ITERATE)
  console.log('ğŸš€ ~ æ‹¦æˆªäº†ownKeysè¡Œä¸º')
  return Reflect.ownKeys(target)
}

export default {
  get: getHandler,
  ownKeys: ownKeysHandler
}
```

### ç¬¬äº”æ­¥

é’ˆå¯¹å†™å…¥å±æ€§ è¿›è¡Œæ‹¦æˆª

- proxyObj.c.name
- proxyObj.a = 1
- proxyObj.a = 2
- proxyObj.d = 2
- delete proxyObj.d
- delete proxyObj.a

1. åœ¨ utils ä¸‹å¢åŠ  trigger çš„æšä¸¾å€¼
2. åœ¨ effect ä¸‹å¢åŠ  trigger.js
3. åœ¨ handles ä¸‹å¢åŠ  set å’Œ deleteProperty çš„æ‹¦æˆª

```js
// 1.åœ¨ utils ä¸‹å¢åŠ  trigger çš„æšä¸¾å€¼
//// ä¿®æ”¹å·²æœ‰å±æ€§ set
//// å¢åŠ å·²æœ‰å±æ€§add
//// åˆ é™¤å±æ€§ delete
export const triggerTypes = {
  SET: 'set',
  ADD: 'add',
  DELETE: 'delete'
}
// 2.åœ¨ effect ä¸‹å¢åŠ  trigger.js
function trigger(target, type, key, value) {
  console.log('ğŸš€ ~ trigger ~ type:', type)
  // console.log(
  //   'ğŸš€ ~ trigger ~ target, type, key, value:',
  //   target,
  //   type,
  //   key,
  //   value
  // )
}

export default trigger

// 3.åœ¨ handles ä¸‹å¢åŠ  set å’Œ deleteProperty çš„æ‹¦æˆª

import reactive from '../reactive.js'
import {
  isObject,
  trackTypes,
  triggerTypes,
  hasChanged
} from '../utils/index.js'


import track from '../effect/track.js'
// xxx

function setHandler(target, key, value) {
  //  ç±»å‹æ˜¯ æ–°å¢ è¿˜æ˜¯ ä¿®æ”¹
  const type = target.hasOwnProperty(key) ? triggerTypes.SET : triggerTypes.ADD
  const oldValue = target[key]
  const result = Reflect.set(target, key, value)

  // å¦‚æœå€¼æ²¡æ›´æ–°
  if (hasChanged(value, oldValue)) {
    trigger(target, type, key, value)
  }

  return result
}

function deleteHandler(target, key) {
  // ä¸èƒ½æ¯æ¬¡éƒ½ç›´æ¥è§¦å‘ å…ˆåˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨
  const hasKey = target.hasOwnProperty(key)
  const result = Reflect.deleteProperty(target, key)
  if (hasKey) {
    trigger(target, triggerTypes.DELETE, key)
  }
  return result
}

export default {
  set: setHandler,
  deleteProperty: deleteHandler
}
```

### ç¬¬å…­æ­¥

è¾¹ç•Œä¸Šçš„åˆ¤æ–­

```js
// reactive.js
import handler from './handles/index.js'
import { isObject } from './utils/index.js'

// å­˜å‚¨åŸå§‹å¯¹è±¡å’Œä»£ç†å¯¹è±¡çš„ä¹‹é—´çš„æ˜ å°„
const reactiveMap = new WeakMap()

function reactive(target) {
  // å¦‚æœä¸æ˜¯å¯¹è±¡çš„è¯ç›´æ¥è¿”å›
  if (!isObject(target)) {
    return target
  }
  // å¦‚æœå·²ç»ä»£ç†è¿‡äº† ç›´æ¥è¿”å›
  if (reactiveMap.has(target)) {
    return reactiveMap.get(target)
  }

  const proxy = new Proxy(target, handler)
  reactiveMap.set(target, proxy)
  return proxy
}

export default reactive
```

## å¯¹ æ•°ç»„çš„æ“ä½œ

```js
import reactive from './reactive.js'

const proxyObj = reactive({
  a: 1,
  b: 2,
  c: {
    name: 'å¼ ä¸‰',
    age: 18
  }
})

const arr = [1, proxyObj, 2]

const proxyArr = reactive(arr)

// proxyArr[0]
// proxyArr[0] = 1
// proxyArr[0] = 2

// proxyArr.length
// delete proxyArr[0]
// for (const key in proxyArr) {
//   proxyArr[key]
// }
// proxyArr.includes(proxyObj)
// console.log('ğŸš€ ~ proxyArr.includes(proxyObj):', proxyArr.includes(proxyObj))
// console.log(proxyArr.includes(1))
// console.log(proxyArr.indexOf(1))
// console.log(proxyArr.lastIndexOf(1))

// delete proxyArr[0]
// console.log(proxyArr.includes(proxyObj)) // -> false ç»“æœå¼‚å¸¸

// proxyArr.push(3)
// proxyArr.pop()
// proxyArr.shift()
// proxyArr.unshift(0)

// proxyObj.a = 1
// proxyObj.a = 2
// proxyObj.d = 2
// delete proxyObj.d
// proxyObj.c.name
// delete proxyObj.a
```

### æ•°ç»„ä¸­æŸ¥æ‰¾å¯¹è±¡

```js
import reactive from './reactive.js'

const proxyObj = reactive({
  a: 1,
  b: 2,
  c: {
    name: 'å¼ ä¸‰',
    age: 18
  }
})

const arr = [1, proxyObj, 2]

const proxyArr = reactive(arr)

proxyArr.includes(proxyObj) // åº”è¯¥ä¸º true ä½†æ˜¯ä¸º false
```

```js
// handles/index.js
// åœ¨æ•°ç»„æ–¹æ³•æ“ä½œçš„æ—¶å€™çš„æ—¶å€™æŸ¥è¯¢åŸå§‹å¯¹è±¡ è€Œä¸æ˜¯ä»£ç†å¯¹è±¡
import reactive from '../reactive.js'
import {
  isObject,
  trackTypes,
  triggerTypes,
  hasChanged,
  RAW
} from '../utils/index.js'

import track from '../effect/track.js'
import trigger from '../effect/trigger.js'

const arrayInstrumentations = {}

;['includes', 'indexOf', 'lastIndexOf'].forEach((key) => {
  arrayInstrumentations[key] = function (...args) {
    const res = Array.prototype[key].apply(this, args)
    if (res === -1 || res === false) {
      // 2. å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨åŸå§‹å€¼ï¼Œè€Œä¸æ˜¯ä»£ç†çš„å¯¹è±¡
      return Array.prototype[key].apply(this[RAW], args)
    }
    return res
  }
})

function getHandler(target, key) {
  // å¢åŠ è‡ªå®šä¹‰æ ‡è¯†ï¼Œè¿”å›åŸå§‹å¯¹è±¡ é¿å…å’Œå·²æœ‰å±æ€§é‡å¤
  if (key === RAW) {
    return target
  }
  track(target, trackTypes.GET, key)

  if (arrayInstrumentations.hasOwnProperty(key) && Array.isArray(target)) {
    return arrayInstrumentations[key]
  }

  const result = Reflect.get(target, key)
  return isObject(result) ? reactive(result) : result
}

export default {
  get: getHandler
}
```

### æ•°ç»„é•¿åº¦è®¾ç½®

```js
proxyArr[5] = 100
proxyArr.length = 10
```

```js
function setHandler(target, key, value) {
  //  ç±»å‹æ˜¯ æ–°å¢ è¿˜æ˜¯ ä¿®æ”¹
  const type = target.hasOwnProperty(key) ? triggerTypes.SET : triggerTypes.ADD
  const oldValue = target[key]

  const ordLength = Array.isArray(target) ? target.length : undefined
  const result = Reflect.set(target, key, value)

  if (hasChanged(value, oldValue)) {
    trigger(target, type, key, value)

    // åˆ¤æ–­ length æ˜¯å¦æœ‰å˜åŒ–ï¼Œå¦‚æœæœ‰å˜åŒ– æ‰‹åŠ¨å¯¹ length æ´¾å‘æ›´æ–°
    if (Array.isArray(target) && ordLength !== target.length) {
      //  length éšå¼çš„æ”¹å˜è¿˜ä¼šè§¦å‘ä¸€æ¬¡ (arr[100] = 100)
      if (key !== 'length') {
        trigger(target, triggerTypes.SET, 'length')
      } else {
        // è¯´æ˜ length æ˜¾å¼çš„å‘ç”Ÿäº†æ”¹å˜ (arr.length = 100)
        for (let i = target.length; i < ordLength; i++) {
          trigger(target, triggerTypes.DELETE, i.toString())
        }
      }
    }
  }

  return result
}
```

### push pop æ“ä½œ, è‡ªå®šä¹‰æ”¶é›†ä¾èµ–

```js
// handles/index.js
const arrayInstrumentations = {}

;['includes', 'indexOf', 'lastIndexOf'].forEach((method) => {
  arrayInstrumentations[method] = function (...args) {
    const res = Array.prototype[method].apply(this, args)
    if (res === -1 || res === false) {
      // 2. å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨åŸå§‹å€¼ï¼Œè€Œä¸æ˜¯ä»£ç†çš„å¯¹è±¡
      return Array.prototype[method].apply(this[RAW], args)
    }
    return res
  }
})
;['push', 'poo', 'shift', 'unshift', 'splice'].forEach((method) => {
  arrayInstrumentations[method] = function (...args) {
    pauseTracking() // æš‚åœä¾èµ–æ”¶é›†
    const res = Array.prototype[method].apply(this, args)
    resumeTracking() // æ¢å¤ä¾èµ–æ”¶é›†
    return res
  }
})

// effect/track.js

// æ˜¯å¦éœ€è¦æ”¶é›†ä¾èµ–
let shouldTrack = true

/**
 * æš‚åœä¾èµ–æ”¶é›†
 */
export function pauseTracking() {
  shouldTrack = false
}

/**
 *  æ¢å¤ä¾èµ–æ”¶é›†
 */
export function resumeTracking() {
  shouldTrack = true
}

function track(target, type, key) {
  if (!shouldTrack) return false
  console.log(`ğŸš€ ~ ä»£ç†å¯¹è±¡çš„${type}è¡Œä¸ºè¢«æ‹¦æˆª, æ“ä½œçš„å±æ€§ä¸º:${key}`)
}
export default track
```
