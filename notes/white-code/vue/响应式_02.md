å®ç°ç®€ç‰ˆçš„ effect

ç»“åˆ `track` å’Œ `trigger`

```js
const data = {
  a: 1,
  b: 2,
  c: 3
}

let activeEffect = null

const state = new Proxy(data, {
  get(target, key) {
    track(target, key)
    return target[key]
  },
  set(target, key, value) {
    target[key] = value
    trigger(target, key)
    return true
  }
})

const track = (target, key) => {}

const trigger = (target, key) => {
  console.log(`ğŸš€ ~ ä»£ç†å¯¹è±¡çš„setè¡Œä¸ºè¢«æ‹¦æˆª, æ“ä½œçš„å±æ€§ä¸º:${key}`)
}

const effect = (fn) => {}
// æµ‹è¯• 1
// effect(() => {
//   console.log(state.a)
// })
// æµ‹è¯• 2
// effect(() => {
//   console.log(state)

//   if (state.a === 1) {
//     state.b
//   } else {
//     state.c
//   }
// })

// state.a = 2

// æµ‹è¯•3
// effect(() => {
//   if (state.a === 1) {
//     state.b
//   } else {
//     state.c
//   }
//   console.log('ğŸš€ ~ effect ~ å‡½æ•°1æ‰§è¡Œ:')
// })
// effect(() => {
//   console.log(state.c)
//   console.log('ğŸš€ ~ effect ~ å‡½æ•°2æ‰§è¡Œ:')
// })
// state.a = 2

// æµ‹è¯•4
// effect(() => {
//   if (state.a === 1) {
//     state.b
//   } else {
//     state.c
//   }
//   console.log('ğŸš€ ~ effect ~ å‡½æ•°1æ‰§è¡Œ:')
// })
// effect(() => {
//   console.log(state.a)
//   console.log(state.c)
//   console.log('ğŸš€ ~ effect ~ å‡½æ•°2æ‰§è¡Œ:')
// })
// state.a = 2
```

1.  effect å®åœ¨è®¿é—® ä»£ç†å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œæ‰€ä»¥ä¼šè§¦å‘ track çš„æ‹¦æˆª

    > - åœ¨ track ä¸­, key å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ‹¿åˆ° é‚£å‡½æ•°å‘¢?
    >   > 1. å‡½æ•°é€šè¿‡å…¨å±€å˜é‡ä¿å­˜ æ‰€ä»¥å®šä¹‰ä¸€ä¸ª activeEffect æ¥ä¿å­˜å½“å‰çš„å‡½æ•°.
    >   > 2. å¯èƒ½ä¼šæœ‰å¤šä¸ª key ä¾èµ–å¤šä¸ªå‡½æ•° æ‰€ä»¥æ¥ä¸€ä¸ª map æ¥ä¿å­˜ä¾èµ–å…³ç³»

## v0.1.0

æ‰€ä»¥ä»£ç ä¸­ä¿®æ”¹å¦‚ä¸‹

```js
let activeEffect = null

let depsMap = new Map()
const track = (target, key) => {
  if (activeEffect) {
    const deps = depsMap.get(key) // æ ¹æ®å±æ€§å€¼å»æ‹¿å¯¹åº”çš„ä¾èµ–é›†åˆ
    if (!deps) {
      depsMap.set(key, (deps = new Set()))
    }
    deps.add(activeEffect) // å°†å½“å‰å…³è”çš„å‡½æ•°æ·»åŠ åˆ°é›†åˆ
    console.log(depsMap)
  }
}
const track = () => {
  activeEffect = fn
  fn()
  activeEffect = null
}
```

æ­¤æ—¶çš„è¾“å‡ºç»“æœä¸ºï¼Œè¡¨æ˜ a å·²ç»è¢«æ”¶é›†åˆ°ä¾èµ–é›†åˆä¸­

```js
// Map(1) { 'a' => Set(1) { [Function (anonymous)] } }
```

2. ä¿®æ”¹
   `state.a = 2`

```js
const trigger = (target, key) => {
  const deps = depsMap.get(key) // ä»é›†åˆä¸­æ‹¿åˆ°å¯¹åº”çš„ä¾èµ–é‡æ–°æ‰§è¡Œ
  if (deps) {
    deps.forEach((effect) => effect())
  }
}
```

### v0.1.0 æ€»ç»“

å®ç°æ€è·¯å¦‚ä¸‹ `æ¯ä¸€ä¸ªå±æ€§å¯¹åº”ä¸€ä¸ª set é›†åˆ`ï¼Œé›†åˆä¸­æ˜¯æ‰€ä¾èµ–çš„å‡½æ•°ï¼Œæ‰€æœ‰å‡½æ•°åŠå¯¹åº”çš„ä¾èµ–å‡½æ•°é›†åˆæ•´ç†ä¸ºä¸€ä¸ª map ç»“æ„

å®šä¹‰ ä¸€ä¸ª activeEffect ä¸­é—´å˜é‡ï¼Œæ¥ä¿å­˜è¿™ä¸ªå›æ‰å‡½æ•°ï¼Œç­‰ä¾èµ–æ”¶é›†å®Œæˆä¹‹ååœ¨è®¾ç½®ä¸º ç©º

![image](../../images/effect/v0.1.0.png)

## v0.1.1

```js
// æ‰§è¡Œæµ‹è¯• 2 çš„ä»£ç 
effect(() => {
  console.log(state)

  if (state.a === 1) {
    state.b
  } else {
    state.c
  }
})
state.a = 2
```

ä¸¤æ¬¡è¿è¡Œçš„å›æ‰å‡½æ•° å»ºç«‹çš„ä¾èµ–å…³ç³»æ˜¯ç›¸åŒçš„

åº”è¯¥ ç¬¬ä¸€æ¬¡æ˜¯ aã€b ç¬¬äºŒæ¬¡æ˜¯ aã€c

ä½†æ˜¯æ‰§è¡Œç»“æœå¦‚ä¸‹

```js
ğŸš€ ~ effect ~ å‡½æ•°æ‰§è¡Œ:
Map(1) { 'a' => Set(1) { [Function (anonymous)] } }
Map(2) {
  'a' => Set(1) { [Function (anonymous)] },
  'b' => Set(1) { [Function (anonymous)] }
}

ğŸš€ ~ effect ~ å‡½æ•°æ‰§è¡Œ:
Map(2) {
  'a' => Set(1) { [Function (anonymous)] },
  'b' => Set(1) { [Function (anonymous)] }
}
Map(2) {
  'a' => Set(1) { [Function (anonymous)] },
  'b' => Set(1) { [Function (anonymous)] }
}

```

é—®é¢˜åˆ†æ

ç¬¬ä¸€æ¬¡å»ºç«‹ä¾èµ–å…³ç³»çš„æ—¶å€™ï¼Œæ˜¯å°†ä¾èµ–å‡½æ•°èµ‹å€¼ç»™ activeEffectï¼Œæœ€ç»ˆæ˜¯é€šè¿‡ activeEffect å°†ä¾èµ–å‡½æ•°æ·»åŠ  æ‰§è¡Œå®Œæˆåé‡æ–°èµ‹å€¼ä¸º null

ä¹‹åå±æ€§å€¼å˜åŒ–ï¼Œé‡æ–°è¿è¡Œçš„æ˜¯å›æ‰å‡½æ•°ï¼Œä½†æ˜¯ activeEffect å€¼ä¸º null ï¼Œæ‰€ä»¥å°±å¯¼è‡´ä¾èµ–ä¸€ç›´è¢«æ”¶é›†ä¸è¿›å» æ‰§è¡Œçš„ä¸€ç›´æ˜¯ å¦‚ä¸‹ callback

```js
;() => {
  console.log('ğŸš€ ~ effect ~ å‡½æ•°æ‰§è¡Œ:')
  if (state.a === 1) {
    state.b
  } else {
    state.c
  }
}
```

æ”¹é€ æ–¹æ¡ˆ
åœ¨æ”¶é›†ä¾èµ–çš„æ—¶å€™, ä¸å†æ”¶é›†ä¾èµ–å‡½æ•°ï¼Œè€Œæ˜¯æ”¶é›†ä¸€ä¸ªåŒ…å«æœ‰ activeEffect çš„ç¯å¢ƒä»£ç ,è¿™æ ·å°±å¯ä»¥ä¿è¯ activeEffect ä¸€ç›´æœ‰å€¼

```js
const effect = (fn) => {
  const environment = () => {
    activeEffect = environment
    fn()
    activeEffect = null
  }
  environment()
}
```

æ‰§è¡Œç»“æœå¦‚ä¸‹

```js
ğŸš€ ~ effect ~ å‡½æ•°æ‰§è¡Œ:
Map(1) { 'a' => Set(1) { [Function: environment] } }
Map(2) {
  'a' => Set(1) { [Function: environment] },
  'b' => Set(1) { [Function: environment] }
}
ğŸš€ ~ effect ~ å‡½æ•°æ‰§è¡Œ:
Map(2) {
  'a' => Set(1) { [Function: environment] },
  'b' => Set(1) { [Function: environment] }
}
Map(3) {
  'a' => Set(1) { [Function: environment] },
  'b' => Set(1) { [Function: environment] },
  'c' => Set(1) { [Function: environment] }
}
```

ä½†æ˜¯ b çš„ä¾èµ–æ²¡æœ‰è¢«åˆ é™¤é˜¿ ï½ï½

> éœ€è¦æ¸…é™¤æ—§çš„ä¾èµ–, é‚£ä¸€ä¸ª key å¯èƒ½åœ¨å¤šä¸ª effect ä¸­å»ä½¿ç”¨ï¼Œæ‰€ä»¥éœ€è¦è®°å½•è¿™ä¸ªç¯å¢ƒä½¿ç”¨äº†å¤šå°‘æ¬¡

åœ¨ track çš„æ—¶å€™å°±éœ€è¦è¿›è¡Œè®°å½•äº†ï¼Œ è®°å½•ç¯å¢ƒå’Œé›†åˆçš„å…³ç³»

ä¸‡ç‰©çš†å¯¹è±¡ æ‰€ä»¥ç»™ environment å‡½æ•°ä¸Šå®šä¹‰ä¸€ä¸ª deps -> []

é‚£ä¹ˆåœ¨ track çš„æ—¶å€™åªéœ€è¦å°†å½“å‰ä¾èµ–çš„é›†åˆæ·»åŠ å°±å¥½

ä»£ç æ”¹é€ å¦‚ä¸‹

```js
const effect = (fn) => {
  const environment = () => {
    activeEffect = environment
    cleanup()
    fn(environment)
    activeEffect = null
  }
+++  environment.deps = [] // è®°å½•ç¯å¢ƒå‡½æ•°åœ¨å“ªäº›é›†åˆä¸­ä½¿ç”¨
  environment()
}



const track = (target, key) => {
  if (activeEffect) {
    let deps = depsMap.get(key) // æ ¹æ®å±æ€§å€¼å»æ‹¿å¯¹åº”çš„ä¾èµ–é›†åˆ
    if (!deps) {
      depsMap.set(key, (deps = new Set()))
    }
    deps.add(activeEffect) // å°†å½“å‰å…³è”çš„å‡½æ•°æ·»åŠ åˆ°é›†åˆ
++++    activeEffect.deps.push(deps) // å°†å½“å‰çš„ä¾èµ–é›†åˆæ·»åŠ åˆ°ç¯å¢ƒå‡½æ•°çš„deps
  }
  console.log(depsMap)
}

const cleanup = (environment) => {
  // 1. æ‹¿åˆ°å½“å‰ç¯å¢ƒçš„ä¾èµ–
  let deps = environment.deps
  // 2. éå†ä¾èµ–ï¼Œåˆ é™¤ä¾èµ–
  if (deps.length) {
    deps.forEach((dep) => {
      dep.delete(environment)
      if (dep.size === 0) {
        for (const [key, value] of depsMap) {
          if (value === dep) {
            depsMap.delete(key)
          }
        }
      }
    })
    deps.length = 0
  }
}

```

æ­¤æ—¶å»ºç«‹çš„ä¾èµ–å…³ç³»ä¸º

```js

ğŸš€ ~ effect ~ å‡½æ•°æ‰§è¡Œ:
Map(1) { 'a' => Set(1) { [Function: environment] { deps: [Array] } } }
Map(2) {
  'a' => Set(1) { [Function: environment] { deps: [Array] } },
  'b' => Set(1) { [Function: environment] { deps: [Array] } }
}
ğŸš€ ~ effect ~ å‡½æ•°æ‰§è¡Œ:
Map(1) { 'a' => Set(1) { [Function: environment] { deps: [Array] } } }
Map(2) {
  'a' => Set(1) { [Function: environment] { deps: [Array] } },
  'c' => Set(1) { [Function: environment] { deps: [Array] } }
}
```

ä½†æ˜¯åœ¨æ‰§è¡Œæµ‹è¯• 4 çš„æ—¶å€™ è¿›å…¥åˆ°äº†æ— é™å¾ªç¯

åŸå› :

1. åˆå§‹åŒ–æ‰§è¡Œ effect æ—¶ï¼Œstate.a = 1 ï¼Œå› æ­¤ç¬¬ä¸€ä¸ª effect ä¼šè®¿é—® state.b ç¬¬äºŒä¸ª effect ä¼šè®¿é—® state.a å’Œ state.c
2. å½“ start.a ä¿®æ”¹ä¸º 2 æ—¶ï¼Œtrigger å‡½æ•°ä¼šè§¦å‘æ‰€æœ‰ä¾èµ– state.a çš„ effect å‡½æ•°
3. ç¬¬äºŒä¸ª effect è¢«è§¦å‘åï¼Œä¼šè®¿é—® state.a è¿™æ—¶ track å‡½æ•°åˆä¼šæŠŠå½“å‰ activeEffect æ·»åŠ åˆ° state.a çš„ä¾èµ–é›†åˆä¸­
4. state.a è¢«ä¿®æ”¹ï¼Œä¼šå†æ¬¡å‡ºå‘ triggerï¼Œå¯¼è‡´ç¬¬äºŒä¸ª effect å†æ¬¡æ‰§è¡Œï¼Œå¯¼è‡´æ— é™å¾ªç¯

```js
const trigger = (target, key) => {
  const deps = depsMap.get(key)
  if (deps) {
    const effectsToRun = new Set(deps) // åˆ›å»ºä¸€ä¸ªæ–°é›†åˆï¼Œé¿å…æ— é™å¾ªç¯
    effectsToRun.forEach((effect) => effect())
  }
}
```

ç»“æœä¸º

```
Map(1) { 'a' => Set(1) { [Function: environment] { deps: [Array] } } }
Map(2) {
  'a' => Set(1) { [Function: environment] { deps: [Array] } },
  'b' => Set(1) { [Function: environment] { deps: [Array] } }
}
ğŸš€ ~ effect ~ å‡½æ•°1æ‰§è¡Œ:
Map(2) {
  'a' => Set(2) {
    [Function: environment] { deps: [Array] },
    [Function: environment] { deps: [Array] }
  },
  'b' => Set(1) { [Function: environment] { deps: [Array] } }
}
1
Map(3) {
  'a' => Set(2) {
    [Function: environment] { deps: [Array] },
    [Function: environment] { deps: [Array] }
  },
  'b' => Set(1) { [Function: environment] { deps: [Array] } },
  'c' => Set(1) { [Function: environment] { deps: [Array] } }
}
3
ğŸš€ ~ effect ~ å‡½æ•°2æ‰§è¡Œ:
Map(2) {
  'a' => Set(2) {
    [Function: environment] { deps: [Array] },
    [Function: environment] { deps: [Array] }
  },
  'c' => Set(1) { [Function: environment] { deps: [Array] } }
}
Map(2) {
  'a' => Set(2) {
    [Function: environment] { deps: [Array] },
    [Function: environment] { deps: [Array] }
  },
  'c' => Set(2) {
    [Function: environment] { deps: [Array] },
    [Function: environment] { deps: [Array] }
  }
}
ğŸš€ ~ effect ~ å‡½æ•°1æ‰§è¡Œ:
Map(2) {
  'a' => Set(2) {
    [Function: environment] { deps: [Array] },
    [Function: environment] { deps: [Array] }
  },
  'c' => Set(1) { [Function: environment] { deps: [Array] } }
```

### v0.1.1 æ€»ç»“

1. é€šè¿‡ activeEffect æ¥ä¿å­˜å½“å‰çš„å‡½æ•°ï¼Œåœ¨æ‰§è¡Œå®Œä¹‹åè®¾ç½®ä¸º null
2. é€šè¿‡ deps æ¥ä¿å­˜å½“å‰å‡½æ•°ä¾èµ–çš„é›†åˆ
3. é€šè¿‡ cleanup æ¥æ¸…é™¤æ—§çš„ä¾èµ–
4. é€šè¿‡ trigger æ¥è§¦å‘ä¾èµ–

## v0.0.2 effect çš„åµŒå¥—

`æ¥è‡ªæœ‹å‹çš„åˆ†äº« ï½`

```js
// æƒ…å†µ 4
effect(() => {
  effect(() => {
    effect(() => {
      state.c
      console.log('æ‰§è¡Œäº†effect3')
    })
    state.a
    console.log('æ‰§è¡Œäº†effect2')
  })
  state.b
  console.log('æ‰§è¡Œäº†effect1')
})
```

æ¨¡æ‹Ÿå…¥æ ˆå‡ºæ ˆ

```js
const effectStack = []
const effect = (fn) => {
  const environment = () => {
    activeEffect = environment
    // å°†ç¯å¢ƒå‡½æ•°å…¥æ ˆ
    effectStack.push(environment)
    cleanup(environment)
    fn()
    // å°†ç¯å¢ƒå‡½æ•°å‡ºæ ˆ
    effectStack.pop()
    activeEffect = effectStack[effectStack.length - 1]
  }
  environment.deps = [] // è®°å½•ç¯å¢ƒå‡½æ•°åœ¨å“ªäº›é›†åˆä¸­ä½¿ç”¨
  environment()
}
```
