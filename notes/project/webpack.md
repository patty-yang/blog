# webpack 流程优化

## 问我构建流程
> 分为四个步骤: `初始化、编译、生成代码、输出目录`
> 1. 首先对 entry output loader plugins 进行初始化
> 2. 然后从入口文件开始解析,解析的时候通过递归查找到模块的依赖 然后用 loader 将每个模块转为浏览器可执行的 js 代码
> 3. 将每个模块创建出来的代码生成依赖关系图，然后组成一个一个的 chunk
> 4. 将 chunk 输出到指定目录, 并根据配置文件的内容生成对应目录的静态资源
> 5. 因为有暴露的生命周期，所以还会在打包阶段进行对应的处理
>
>

## 八分钟到十秒到构建优化你是怎么做的

优化原因
> 项目最开始是由 webpack 去搭建的 随着模块越来越多 构建时间也越来越长
> 最夸张的是早会完抽支烟都没启动完成 在沟通完工作内容后 我就开始着手处理这个事情

首先考虑的是 vite 毕竟 vite 在开发环境是使用的 esbuild 在有依赖预构建的事
但是我们项目里用到了好多 webpack 生态的插件和 loader 如果切换到 vite 找不到对应的插件就需要自己去实现了 这样的话工作量就不可预期了

所以在不切换构建工具的话就不能跳过打包这个过程了 所以我把重心放在了分析打包耗时上 是使用了
`speed-measure-webpack-plugin` 它会出一份报告
包含各阶段 loader 插件等的耗时

通过对报告的结果分析来看 耗时主要是在 `babel 编译 js,这是耗时大头` 还有就是 `loader 的解析和处理比较耗时`

我做的主要的优化是

**1. 使用 swc 替换 babel 进行编译工作**

**2. 使用 thread-loader 开启多线程 loader 解析**

**3. 当然还有一些别的优化手段, 最终 通过对构建时间在 10 多秒左右**

## 什么是 swc ? 对比 babel 有什么优势

swc 呢是用 rust 编写的一个编译器 因为是基于 rust 的 所以编译速度非常快 并且兼容了大多数的 babel 插件 在迁移过程中没有什么比较大的成本
替换成 swc 后构建时间就减少到了大概三分钟左右 这是一个主要的优化

## **还有一个 loader 解析耗时的问题要描述一下吗**

通过开启多线程并行处理 loader 操作 减少主线程的负担

是用来 thread-loader 后 css 及 图片的 loader 耗时问题也解决了 构建时间大概缩减到了两分钟吧

**还有些其他的手段也是辅助一步一步构建的 10 多秒的 剩下的优化手段还要讲一下吗**

- hash 的持久化缓存
    - 当时是 webpack5 所以想到可以使用 持久化缓存将结果缓存到内存或者文件中 减少不必呀到重复计算和编译
    - 当然 第一次启动的时候 时间上没有变化 毕竟缓存还没有生成 但是缓存之后 你像开发环境是需要频繁部署嘛 这个时间已经缩短到了差不多一分钟

这个时候感觉已经是极限了 但是我比较喜欢多往前走一步 多研究。 所以查了好多资料 也看了好多文章 发现在开发环境下去掉 hash
能进一步压缩在开发环境的构建时间

其实说实话 hash 一开始是不在意的 但这个发现也算是在这个项目中积累到的经验吧

还有最后一个优化手段是 升级了插件的一些版本 因为在一些插件的新版本对于旧版本会修复一些 bug , 在性能和算法优化上也会有一些更新

在当时有个 terser-webpack-plugin 的升级 这个插件所需要的耗时也是挺长的 所以我还想压缩所需要的时间

一开始想了解下插件是如何实现的。但在看文档的时候发现在 `5.x` 版本引入到 swc 我就寻思在性能上优化了一些东西 于是就对这些插件进行了升级

**这就是我针对 webpack 构建优化做的落地方案 不知道您这边有什么更好的建议吗**


<Gitalk />
