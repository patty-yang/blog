## Vue3 å¯¹æ¯” Vue2

è¿™æ˜¯ä¸€ä¸ªå¤§ç‰ˆæœ¬çš„æ›´æ–°ï¼Œæˆ‘è§‰å¾—å¯ä»¥åˆ†ä¸ºå››ç±»

| åˆ†ç±»         | è¯´æ˜Ž                                     |
|------------|----------------------------------------|
| `æºç å±‚é¢çš„ä¼˜åŒ–`  | Vue2 æºç é›†ä¸­ï¼ŒVue3 monorepoï¼Œæ¨¡å—å¯ç‹¬ç«‹å‘å¸ƒï¼Œé¢—ç²’åº¦æ›´ç»†ã€‚ |
| `æ€§èƒ½æ–¹é¢çš„ä¼˜åŒ–`  | è§£å†³åŽ†å²åŒ…è¢±ï¼Œæ€§èƒ½æå‡ã€‚                           |
| `API è¯­æ³•ä¼˜åŒ–` | æ–°å¢ž Composition APIï¼Œä»£ç ç»„ç»‡æ›´çµæ´»ã€‚            |
| `å¼•å…¥RFC`    | ç¤¾åŒºå‚ä¸Žåº¦æå‡ï¼ŒæŒç»­å®Œå–„ã€‚                          | 

**ðŸ› ï¸ 1. æºç å±‚é¢çš„å˜åŒ–**

åœ¨`vue2`çš„æºç æ˜¯åœ¨ `src`ç›®å½•ä¸‹çš„,ç„¶åŽæ ¹æ®åŠŸèƒ½æ‹†åˆ†å‡ºæ¥ä¸åŒçš„æ–‡ä»¶å¤¹

â”œâ”€â”€ `complier`: ç¼–è¯‘å™¨  
â”œâ”€â”€ `core`: å’Œå¹³å°æ— å…³çš„é€šç”¨è¿è¡Œæ—¶ä»£ç   
â”œâ”€â”€ `server`: æœåŠ¡ç«¯æ¸²æŸ“  
â”œâ”€â”€ `sfc`: å•æ–‡ä»¶è§£æžä»£ç   
â”œâ”€â”€ `shared`: å…±äº«ä»£ç åº“

å› ä¸ºæ˜¯åœ¨`src`ç›®å½•ä¸‹,æ‰€ä»¥æ— æ³•**å•ç‹¬æŠ½ç¦»**å‡ºæ¥,æ— æ³•å¯¹å•ä¸ªæ¨¡å—è¿›è¡Œå‘å¸ƒ

åœ¨`vue3`æ”¹ä¸ºäº†`monorepo`çš„å½¢å¼,å°†æ¨¡å—æ‹†åˆ†ä¸ºç‹¬ç«‹çš„åŒ…,æ¯ä¸ªåŒ…èƒ½å•ç‹¬çš„è¿›è¡Œå‘å¸ƒéƒ¨ç½²ã€‚é¢—ç²’åº¦æ›´ç»†

**ðŸš€ 2. æ€§èƒ½ä¼˜åŒ–**

1. ts æ”¯æŒ
    - vue1.x çº¯ js å¼€å‘
    - vue2.x Flow.js
    - vue3.x Typescript

2. æºç ä½“ç§¯ç¼©å°
    - ç§»é™¤å†·é—¨åŠŸèƒ½: `filter`ã€`inline-template`
    - ç”Ÿäº§çŽ¯å¢ƒç”¨ `rollup` æž„å»ºï¼Œ`tree-shaking`
3. æ•°æ®åŠ«æŒä¼˜åŒ–
    - `vue2`: `Object.defineProperty`
    - `vue3`: `Proxy`
4. ç¼–è¯‘ä¼˜åŒ–
    - é™æ€æå‡ã€é¢„å­—ç¬¦ä¸²ä¼˜åŒ–ã€ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°ã€`Block Tree`ã€`PatchFlag`
5. diff ç®—æ³•ä¼˜åŒ–
    - `vue2`: åŒç«¯ diff
    - `vue3`: å¿«é€Ÿ diff

---

**ðŸ§© 3. è¯­æ³• API çš„å˜åŒ–**

1. é€»è¾‘ç»„ç»‡çš„ä¼˜åŒ–
    - `options API`: å¤ç”¨çš„é¢—ç²’åº¦æ˜¯ç»„ä»¶çº§åˆ«
    - `composition API`: å¤ç”¨çš„é¢—ç²’åº¦æ˜¯å‡½æ•°çº§åˆ«
2. ä¼˜åŒ–é€»è¾‘å¤ç”¨
    - `mixin` çš„ç¼ºç‚¹
        - ä¸æ¸…æ™°çš„æ•°æ®æ¥æº
        - å‘½åç©ºé—´çš„å†²çª
        - éšå¼çš„è·¨ `mixin` äº¤æµ
3. å…¶ä»–å˜åŒ–
    - åŽ»æŽ‰äº† `new Vue` çš„æž„é€ å‡½æ•°
      | `vue2`         | `vue3`                                     |
      |------------|----------------------------------------|
      | è°ƒç”¨æž„é€ å‡½æ•°çš„é™æ€æ–¹æ³•ä¼šå¯¹æ‰€æœ‰çš„ `vue` åº”ç”¨ç”Ÿæ•ˆ,ä¸åˆ©äºŽéš”ç¦»ä¸åŒçš„åº”ç”¨ | |
      | æž„é€ å‡½æ•°ç»§æ‰¿äº†å¤ªå¤šçš„åŠŸèƒ½, ä¸åˆ©äºŽ `tree-shaking`  | æŒ‰éœ€å¯¼å…¥,åˆ©äºŽ `tree-shaking` |
      | æ²¡æœ‰åŒºåˆ†ç»„ä»¶å®žä¾‹å’Œåº”ç”¨,é€šè¿‡ new Vue åˆ›å»ºçš„å¯¹è±¡,å³æ—¶ä¸€ä¸ª `vue`åº”ç”¨,åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„`vue`ç»„ä»¶ | å°†ä¸¤ä¸ªæ¦‚å¿µåŒºåˆ†
      `é€šè¿‡createApp`åˆ›å»ºçš„å¯¹è±¡æ˜¯ä¸€ä¸ªVueåº”ç”¨,å†…éƒ¨æä¾›çš„æ–¹æ³•æ˜¯é’ˆå¯¹æ•´ä¸ªåº”ç”¨çš„ |

**ðŸ’¡ 4. RFC**
> æ”¶é›†ç¤¾åŒºå¯¹æŸä¸ªæ–°åŠŸèƒ½ã€æ”¹åŠ¨æˆ–æ ‡å‡†çš„å»ºè®®å’Œæ„è§

## vue3 å“åº”å¼çš„å˜åŒ–

1. **æ‹¦æˆª**
    - `Object.defineProperty` é’ˆå¯¹çš„æ˜¯å¯¹è±¡ç‰¹å®šå±žæ€§çš„**è¯»å†™**æ“ä½œè¿›è¡Œæ‹¦æˆªï¼Œè¡¨ç¤ºçš„æ˜¯ æ–°å¢ž/åˆ é™¤å±žæ€§çš„ç›‘æµ‹ä¸åˆ°çš„
    - `Proxy` èƒ½å¯¹å¯¹è±¡çš„æ•´ä¸ªæ“ä½œè¿›è¡Œæ‹¦æˆª
2. **å“åº”å¼**
    - `vue2` é€šè¿‡ `data` æ¥åˆ›å»ºçš„å“åº”å¼æ•°æ®
    - `vue3`ä¸­çš„
        - `ref` æ˜¯é€šè¿‡ `Object.defineProperty`
        - å¯¹è±¡æ˜¯é€šè¿‡ `Proxy`
3. ä¾èµ–æ”¶é›†çš„å˜åŒ–
    - `vue2` æ˜¯é€šè¿‡ `Watcherã€Dep`
        - æ¯ä¸ªå“åº”å¼å±žæ€§éƒ½æœ‰ä¸ª `Dep`å®žä¾‹ï¼Œç”¨æ¥ä¾èµ–æ”¶é›†ï¼Œå†…éƒ¨åŒ…å«äº†ä¸€ä¸ªæ•°ç»„ï¼Œå­˜å‚¨ä¾èµ–è¿™ä¸ªå±žæ€§çš„æ‰€æœ‰ `Watcher`
        - å½“å±žæ€§å€¼å‘ç”Ÿå˜åŒ–, `Dep` ä¼šé€šçŸ¥æ‰€æœ‰çš„ `Watcher` åŽ»åšæ›´æ–°æ“ä½œ
    - `vue3 3.5` æ˜¯é€šè¿‡ `WeakMapã€Mapã€Set`
        - ä¾èµ–æ”¶é›†çš„é¢—ç²’åº¦æ›´ç»†
        - `WeakMap` ä¸­çš„ `key` å¯¹åº”çš„æ˜¯å“åº”å¼å¯¹è±¡,å€¼æ˜¯ `Map`,è¿™ä¸ª `Map` çš„ `key` æ˜¯å¯¹è±¡çš„å±žæ€§, å€¼æ˜¯ä¸€ä¸ª `Set`
          å­˜å‚¨äº†æ‰€æœ‰ä¾èµ–äºŽè¿™ä¸ªå‡½æ•°çš„ `effect` å‡½æ•°
    - `vue3 3.6` æ˜¯é€šè¿‡é“¾è¡¨çš„æ–¹å¼
        - `deps` `nextDeps`
        - `subs`
        - TODO: å¾…æ¢³ç†

## nextTick

- åŒæ­¥ä»£ç ä¸­å¤šæ¬¡å¯¹å“åº”å¼æ•°æ®åšäº†ä¿®æ”¹ï¼Œå¤šæ¬¡ä¿®æ”¹ä¼šè¢«åˆå¹¶ä¸ºä¸€æ¬¡ï¼Œä¹‹åŽé€šè¿‡æœ€ç»ˆçš„ä¿®æ”¹ç»“æžœ**å¼‚æ­¥**åŽ»æ›´æ–° DOM
- å¦‚æžœä¸åˆå¹¶çš„è¯ï¼Œæ•°æ®ä¸€æ”¹å˜åŒæ­¥æ›´æ–°ï¼Œä¼šå¯¼è‡´é¢‘ç¹çš„é‡ç»˜å’Œé‡æŽ’

> å¼‚æ­¥æ›´æ–°å¸¦æ¥äº† `æ— æ³•åŠæ—¶èŽ·å–æ›´æ–°åŽçš„ DOM å€¼`  
> é‚£ä¹ˆè§£å†³æ–¹æ¡ˆå°±æ˜¯: **å°†èŽ·å–`DOM`æ•°æ®çš„åŒæ­¥ä»£ç **åŒ…è£…æˆä¸€ä¸ªå¾®ä»»åŠ¡,æµè§ˆå™¨åœ¨å®Œæˆä¸€æ¬¡æ¸²æŸ“åŽ,å°±ä¼šç«‹å³æ‰§è¡Œå¾®ä»»åŠ¡

```js
class Component {
  _data = {
    name: ''
  }
  pending = false

  constructor() {
    this.data = new Proxy(this._data, {
      set: (target, key, value) => {
        const res = Reflect.set(target, key, value)
        if (!this.pending) {
          this.pending = true
          Promise.resolve().then(() => {
            this.render();
            this.pending = false
          })
        }
        return res
      }
    });
  }

  render() {
    console.log(this.data.name);
  }
}

const comp = new Component();

comp.data.name = '1';
comp.data.name = '2';
comp.data.name = '3';
comp.data.name = '4';

```