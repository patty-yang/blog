## vite 性能优化

vite 官方宣称是下一代的工具链,本身的优化已经比较出色了,特别是开发阶段,依靠了 esbuild 处理的依赖预构建,
开发体验已经算拉满了，但在**开发过程中还是发现一些小问题**,
如果开发过程中有动态的依赖导入,**特别是和路由懒加载结合在一起使用的时候**,第一次运行会导致依赖预构建重新加载,导致跳转失败,或者页面闪烁

通过分析最后发现是 类似于 `element-plus vant` 等这种可以按需加载的组件, vite 的优化触发 是在 style 样式加载,
我们的处理方式是在开发模式 把所有组件的样式全部加载了,将样式直接先加到依赖预构建中(`optimizeDeps`)

另外的优化点就是在打包优化了

不过优化的话并不是盲目的优化,首先确保量化指标,没有指标的话也没有目标

一般情况来说, **最重要的一点就是 资源的压缩**, 只有资源压缩减少了,代码提及才会减少。所以对于资源的压缩都是常规性的代码压缩,
gzip 图片压缩。
当然 vite 本身也是基于 ESM 的,开发时注意下按需引入就好了

哦对，还有一个点就**是分包了,更好的利用浏览器缓存**

分包的话，函数的方式不过方式 在 vite4 中不安全, 因为 element-plus 这种库也依赖 vue, 单独拆分 vue
的话会导致循环依赖的错误问题)

但是**为了平衡浏览器缓存的利用率,首页文件加载过大**,我的方法是**将 node_modules 中的第三方库包打到一个
vendor里，过大的第三方包去独立分包,业务代码维持单 chunk, 通过 http2保证页面的加载速度**

就通过分包的处理, 我们项目 vite 的构建时间减少了 12s 左右吧,首次需要加载的文件体积小了接近 1mb

另外 网络的优化对项目整体性能提升也很明显，比如**提到的 HTTP2 开启，可以明显提升传统的 HTTP 1.1 存在对头阻塞的问题 **
,还可以开启 DNS 预解析，提前缓存IP地址,改善用户第一次访问的体验。

对于比较重要的资源可以通过 preload 进行预加载

prefetch，告诉浏览器在空闲的时候去预加载其他页面的资源，可以通过 自定义 vite 插件 `transformIndexHtml` 给链接加上
prefetch,从而达到预加载的效果

通过这一系列的优化吧,开发侧更加的顺畅,打包时间减少了10s左右吧, 主要是用户的感受更加流畅了,
FCP 从2.3s优化到0.7s
LCP 从3.4s优化过后是稳定的1.8s左右,TBT总阻塞时间也控制在 300ms 以内

还有哪些细节需要重点描述一下。

## 预构建

因为 vite 提倡的模块化是 ESM，但在开发时如果不控制的话就会导致两个问题

1. 第三方的模块化规则不能控制
2. 一些ESM处理的第三方依赖(lodash)可能就会导致请求瀑布流的问题

基于这两个 ESM 模块化的缺陷, vite 通过 esbuild 在开发阶段在运行前首先对第三方依赖进行打包处理

另外esbuild是基于go语言来开发的,所以不需要纠结效率的问题,而且每一次依赖预构建的打包都是增量的,而不是全量更新的
而且预构建不仅仅是处理预先打包还会将直接引入的包放在 `.vite/deps` 目录下,如果没找到还会自动导入内容,并重启开发服务器

但是动态导入UI库的话,由于这些styles样式都是存在于 node_modules 中的，所以在动态导入的情况下,vite
的依赖预构建重新加载了新的内容到缓存,导致服务器重新刷新,
而 vite 的开发服务器含有热更新,导致如果在切换路由的时候就好像无效,而且只有第一次是这样，因为新的内容已经加入到预构建的内容中了,下次就不能复现了

复现的话需要将 node_modules/.vite 文件删除,

解决方式是将 ui 库的styles样式加入预构建中。

## 分包

vite 有默认的分包策略，默认的是指区分 `initial chunk` 和 `async chunk`。 但是现实情况下，这并不不够，因为项目中使用了很多的第三方依赖还有开发时编写的代码
都打包到 `initial chunk`中,后续浏览器缓存的利用率太低了,因此需要将第三方依赖和业务代码分开,提高缓存的命中率。

有一些比较大的第三方依赖,需要使用按需加载,当然第三方依赖我还是稍微做了下处理,有些比较稍微大一些的第三方依赖单独进行了打包，防止第三方体积过大

为了防止 `http 1.1` 存在`对头阻塞`的问题,所以我们开启了 `http2`，通过多路复用的特性，来避免每个资源都占用一个 TCP
链接,导致浏览器最大并发请求限制的问题。

不过在 rollup 的 issue 文档中提到，由于chunk数量太多，会导致 google 收录站点存在问题，会影响 SEO 的表现，所以我的策略是

- 将使用的第三方依赖统一合并到 vendor 文件.少数需要按需加载或者体积较大的第三方包,单独构建chunk
- 业务代码单独构建 chunk，配合 CDN开启 HTTP2 的方式，保证页面加载速度
  这样的话既利用了浏览器缓存，夜里用到了网络优势。而且在异步 chunk 的处理上,我还专门使用自定义的插件来进行处理

## vite 自定义插件

link 标签可以通过 `preload` `prefetch`

- `preload` 会告诉浏览器立即加载资源
- `prefetch` 告诉浏览器在空闲的时间加载资源

不过在 vite 中，默认使用的是 module preload，这个属性对模块化支持更好,因为可以模块依赖处理,自动引用关联的 js。不过 module
preload的兼容性不好,仅仅能服务js文件。而且对于路由懒加载模块，我期望的是浏览器空闲时间,帮我下载路由懒加载的模块,也就是使用
prefetch，
经过反复测试，发现 vite 并不支持,因此我就在 vite 的钩子函数 transformIndexHtml 的时候,获取 bundle 链接，将链接都加上
prefetch 属性,再放到 html 页面中

## vite 配置解析的流程

vite 插件主要是扩展了 Rollup 接口, **整个Rollup插件体系主要是两大工作流,build 阶段 和 output 阶段**,基本上整个 rollup
的运行流程，就是两大插件工作流的运行流程。

vite 有和 rollup 通用的钩子，也有vite 独有的钩子,比如 `configResolved`、`transformIndexHtml`

build 过程中,是利用的 rollup 去构建的, vite 只是在做配置的转换,把 vite 的配置转换成 Rollup 的 input 和 output配置。