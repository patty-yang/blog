## 路由自动生成的 vite 插件的编写与发布

### 背景

整个项目使用 vite 搭建，然后整个项目中的页面组件层次和路由配置信息是高度耦合的，于是根据页面组件的目录结构，自动生成路由的配置信息，这样就不用每次新增页面就要去更新路由信息了。

像 nuxtjs umijs 这样的框架，本身就采用的是这种模式，这种模式有个专门的名称，叫"约定式路由"。

大概分为这样几个步骤

1. 读取页面组件目录
2. 根据读取到的信息生成路由的数组
3. 在路由实力中自动生成的数组

当然还有很多要考虑的细节，例如目录需要什么方式去读、路由额外的元数据信息的配置

### 技术描述

##### 读取目录

1. 读取文件和目录常规的方案

   1. 使用 nodejs 的 fs 模块，但是存在一些问题

      1. 不支持热模块的替换
      2. 需要手动实现按需导入和懒加载
      3. 无法直接利用前端构建工具提供的优化功能，如代码分割和懒加载

      但是不同的构建工具分别有提供读取文件和目录的方法

      `常见的构建工具配套的方案`

      ```js
          webpack 使用 require.context
              1. 可以动态加载指定目录下的所有模块
              2. 支持模块热替换

          vite 使用 import.meta.glob
              1. 动态导入指定目录下的所有文件
              2. 支持代码分割和懒加载
              3. 与 vite 的 HMR 功能无缝衔接
      ```

##### 路由额外的元数据信息的配置

1. 首先，通过 import.meta.glob 拿到的路由信息是无法直接使用的，举个例子: 拿到的文件路径是`../views/Home.vue` 但最终要映射的路由路径是 `/home`，所以要对文件路径进行字符串分割、过滤、合并处理，移除重复的目录名和文件名

2. 通过文件路径只能拿到路径和对应的组件是什么，但是路由配置中还存在一些其他的路由元数据，如`标题`、`权限`等信息，参考了微信小程序，为每个页面组件配套了一个 `meta.js` 文件，在 `meta.js` 文件中配置这些元数据信息

### 制作 vite 插件

vite 插件的本质就是一个具有特定结构的 js 对象，这个对象提供了一些钩子函数，可以在 vite 构建流程的不同阶段执行特定的逻辑

```text
导出一个函数，函数的返回结果是一个对象
而这个对象的 `configResolved` 钩子函数封装的就是 读取目录、根据读取到的信息做的二次处理，组装路由配置信息的逻辑
```

### 插件发布

1. 平台准备

   1. GitHub 源码分享
      CHANGELOG、README 等文档
   2. npm 包的发布
      代码压缩

2. 发布

   我选择发布到 npm 上，使用的 rollup 打包，然后在 package.json 中配置入口文件 指定(白名单|黑名单)，我使用的是 白名单，即使后续增加了文件 files 也不需要任何修改

   ```js
    黑名单: .gitignore
    白名单: files
   ```

3. 结束
   通过 vite 插件，对工程化的知识也更加熟悉了，不仅仅是 dependencies 和 devDependencies，但是涉及到发布包，所以针对入口文件配置、白名单配置都有了更深入的了解和掌握，这个也就是编写插件的收获吧
