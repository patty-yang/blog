# Vite 性能优化

## vite 组成结构

vite 官方描述是下一代的工具链,基本上的处理已经够优雅了 特别是开发阶段 依赖 esbuild 的依赖预构建 让开发流程已经很舒服了
但是还有些小问题

如果**开发过程**中有动态导入的依赖 并和路由懒加载一块使用的话 第一次运行会导致预构建的时候重新加载 造成页面进不去或者闪一下的情况。最后发现像
`element-plus` `vant`这些可以按需加载的组件，vite 的优化是在加载样式中 所以在开发环境下直接将样式加入到依赖预构建中

```js
optimizeDeps: {
  include: [
    "element-plus/es/components/**/style/css"
  ]
}
```

另外的优化就是在**生产阶段**了

不过优化也不是空喊，得先确认对应的指标 没有量化的指标也就没有目标

所以在生产阶段 得根据具体的情况进行分析

一般来说就是对资源的压缩 只有当资源减小了 打包提及才会小 用户的请求时间才会减少 所以对资源的压缩一般都是常见的代码压缩
gzip 压缩 图片压缩这一些方案

vite 本身也是基于 ESM 的, 所以代码开发阶段也要注意使用 ESM 的方式按需加载 更有利于 tree shaking

另外就是合理使用分包策略 利用浏览器缓存了 我采用的是 **将 node_modules 中的第三方包放到一个 vendor 中 过大的第三方包独立分包
业务代码维护单 chunk 通过 http2 保证页面的加载速度**

就分包这一块 构建时间减少了大概10-15s左右吧

配合开启 http2 之后 可以明显提升传统的 http1.1 的队头阻塞问题 后续代码更新的时候 能最大程度的复用缓存 提升加载速度

对于比较重要的资源 可以通过 `preload` 优先加载一些资源，还可以通过 `prefetch`让浏览器空闲的时候去加载其他页面的资源

但是 `vite` 默认没有提供 `prefetch` 的功能默认只有 `preload` 所以我自定义了 vite 插件 通过 vite 插件的
`transformIndexHtml` 给链接加上 `prefetch` 从而达到 `prefetch 预加载`的效果

**结果:** 通过这些开发变得丝滑了很多 用户的感觉也是更流畅了 `FCP 2.3s -> 0.7s` `LCP 3.4s -> 1.8s`左右

## 依赖预构建

`vite` 在运行之前 先通过 esbuild 对第三方依赖进行打包处理。因为第三方包的模块化规则我们是不能控制的、还有像类似于 `lodash`
的包可能会导致请求瀑布流的问题。因为 `esbuild` 是基于 `go` 语言开发的,所以不用纠结效率问题，而且每次的预构建都是增量的
而且速度非常快

而且不仅仅是处理预先打包 还会将代码中的 `import` 引入地址进行重写 在开发阶段都会指向 `node_modules/.vite/deps`
目录。并且在开发环境下还能自动的引入依赖添加内容然后重启服务器

但是如果不了解这个机制就会出现 动态导入 `UI` 库,但是由于 `styles` 样式都是存在 `node_modules` 下的。所以在动态导入的情况下
`vite` 的依赖预构建将新的内容添加到了缓存 刷新服务器
而 `vite` 的开发服务器又有 `HMR`，这样就导致切换路由就好像没有效果一样 而且只有第一次是这样 因为新的内容已经加入到预构建中了
下次就不复现了

需要将 `node_modules` 中的 `.vite` 文件删除 才会复现 当然解决方法很简单 直接在配置中将 `UI` 库的 `styles` 样式直接加入预构建就行了

## 分包策略

vite 默认的分包策略只区分 `initial chunk` 和 `async chunk`。但是在实际项目中引入了第三方依赖还有开发的代码都打到
`initial chunk` 中,后续缓存的利用率太低了因此需要将第三方依赖和业务代码区分开,提高缓存的命中率

对第三方依赖使用按需加载 稍微大一些的依赖单独进行打包 防止主包过大




[//]: # (## 开发环境)

[//]: # ()

[//]: # (`在开发环境中使用 Vite 的按需引入功能时，路由切换需要双击才能生效、页面出现闪烁现象，以及路由切换时频繁触发 Vite 的依赖预构建等。`)

[//]: # ()

[//]: # (_问题原因是_ `Vite` 采用了选择性的预处理策略，只会处理常用的组件和依赖，并且在默认配置下会忽略 `node_modules`)

[//]: # (中的文件内容。同时，系统只会在首次访问页面时才处理按需加载的依赖，这就导致了频繁的依赖优化和页面重载。)

[//]: # ()

[//]: # (```js)

[//]: # (optimizeDeps: {)

[//]: # (  include: [)

[//]: # (    "element-plus/es/components/**/style/css")

[//]: # (  ])

[//]: # (})

[//]: # (```)

[//]: # ()

[//]: # (## 生产环境)

[//]: # ()

[//]: # (1. 分包 默认配置: 自动对懒加载和与其对应的 css 进行处理)

[//]: # ()

[//]: # (    - 自定义分包 -> `manualChunks`。 **使用函数的话在 `vite4` 中并不安全, 像 `element-plus` 这种库也依赖了 `vue`)

[//]: # (      如果进行单独拆分的话,会导致循环依赖的错误问题。**)

[//]: # ()

[//]: # (        ```js)

[//]: # (         defineConfig&#40;&#40;&#41; => {)

[//]: # (          return {)

[//]: # (              build: {)

[//]: # (                rollupOptions: {)

[//]: # (                  output: {)

[//]: # (                    // 1. 对象)

[//]: # (                    // manualChunks: {)

[//]: # (                    //   'vue-vendor': ['vue', 'vue-router'])

[//]: # (                    // })

[//]: # (      )

[//]: # (                    // 2. 函数)

[//]: # (                     manualChunks:&#40;id&#41; => {)

[//]: # (                       if&#40;id.includes&#40;'node_modules/vue'&#41;&#41; {)

[//]: # (                         return  'vue')

[//]: # (                       })

[//]: # (                       if&#40;id.includes&#40;'element-plus'&#41;&#41; {)

[//]: # (                         return  'element-plus')

[//]: # (                       })

[//]: # (                       if&#40;id.includes&#40;'lodash-es'&#41;&#41; {)

[//]: # (                         return  'lodash')

[//]: # (                       })

[//]: # (                     }         )

[//]: # (                  })

[//]: # (                })

[//]: # (              })

[//]: # (            })

[//]: # (          }&#41;)

[//]: # (         ```)

[//]: # (2. tree shaking)

[//]: # (   > 必须是 `ES6 module` 的模块才可以, 引入的时候需要引入具体的函数或者对象 不直接导入全对象)

[//]: # (3. 代码压缩)

[//]: # (   ```js)

[//]: # (      minify: 'esbuild' // default)

[//]: # (      // terser)

[//]: # (     // {)

[//]: # (     //     minify: "terser",)

[//]: # (     //     terserOptions: {)

[//]: # (     //        compress: {)

[//]: # (     //           drop_console: true,)

[//]: # (     //           drop_debugger: true)

[//]: # (     //        })

[//]: # (     //     })

[//]: # (     //  })

[//]: # (      ```)

[//]: # (4. GZIP 压缩)

[//]: # (5. 图片压缩)

[//]: # (6. CDN 加速 `external`)

[//]: # (7. vite 独有的生命周期)

[//]: # ()

[//]: # (    - config)

[//]: # (    - configResolved)

[//]: # (    - configurePreviewServer)

[//]: # (    - transformIndexHtml)
