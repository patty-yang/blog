## 是如何去封装的 兼容各平台表单的同步与状态保存的公共模块

> **问题原因**
>
我们那个项目内涉及到了很多的表单要用户填写，由于涉及到的表单项比较多，填写时间比较长再加上还有多标签页窗口的操作
所以就遇到了一些问题

1. 数据丢失
2. 数据恢复
3. 跨标签页通信
4. 冗余数据问题

通过将这些问题梳理后其实就是两个关键问题

1. 数据的自动保存与恢复
2. 多标签页通信

**我考虑的是将这个功能作为一个公共模块,不受库的限制 所以在设计的时候给设置成了 类 的结构**
并不使用特定的 API 保证不论在哪个库或者框架中都是适用的

## 实现过程

在设计的时候 我整理出来两个模块 `FormStorage` `FormStorageManage`

`FormStorage`主要负责

1. 数据本地存储、恢复、删除
2. 多标签的数据广播

`FormStorageManage` 这个类专门管理 `FormStorage`，主要是为了

1. 通过 FormStorageManage 这个类来集中管理所有 FormStorage 实例
2. 避免在每一个 StorageManage 实例中重复绑定全局事件监听, 也算是一个性能上的优化吧

## 本地存储

- localStorage
    - 同步存储，每个域名下有 5-10MB 的存储空间，数据持久型比较高，即使关闭浏览器数据还依旧存在
- sessionStorage
    - 与 localStorage 类似，但是只是在会话阶段 也就是关闭浏览器数据及会被清除
- indexDB
    - 异步存储 支持更复杂的数据结构 比如说对象 存储空间比较大适合存储大量数据和复杂数据

**存储这一块的处理倒是不难，但也算是这个模块的核心功能之一。另一个核心功能是跨标签页通信 我选择的是 BroadcastChannel
来实现的*

## 跨标签页的实现

- localStorage + storage 事件
    - 特点: localstorage 存储数据，利用`storage`事件在不同标签页之间同步数据变化
    - 优点: 兼容性比较好 使用简单
    - 缺点: 只能在同源页面之间通信 数据只能是字符串类型 storage 事件只能在不同标签页之间有效 同一个标签页的同域页面之间无法触发
- service workers
    - 特点: 可以在后台脚本中实现消息的接受和发送
    - 优点: 可以实现更复杂的逻辑，如离线处理、网络请求拦截等。
    - 缺点: 实现比较复杂 需要支持 https 初次设置和调试成本比较高
- post message
    - 特点: 通过 window.postMessage 在不同窗口和 iframe 之间发送消息
    - 优点: 支持跨标签页通信 可以在不同来源的页面之间发消息
    - 缺点: 需要手动管理消息的接受和处理，标签页之间通信需要通过父窗口代理
- broadcastChannel
    - 优点: 使用简单 API 比较友好 支持多标签页 iframe 和窗口之间的即时通信 不受同源限制
    - 缺点: 浏览器支持情况较新 不支持所有旧版浏览器

所以综合考虑后,我选择了 broadcastChannel 这个 api 兼容性也比较好 大多数浏览器都支持
对不支持这个API的浏览器我通过了降级使用 localstorage + storage 做了兼容处理

**这两个处理完之后就是测试和发布了**

## 发布前的准备工作你做了什么

- 冒烟测试，保证功能正常
- 防抖机制的测试,确保不会频繁触发
- 边界情况测试: 浏览器异常关闭、异常数据格式等情况,确保不会报错或降级处理
- 单元测试 vitest
- 打包压缩 rolllup

## 发布

- 发布平台
    - github
        - 源码
        - changelog
        - readme
    - npm
        - 白名单