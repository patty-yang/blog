## åŸå‹ã€åŸå‹é“¾

- åŸå‹
  - æ¯ä¸€ä¸ªæ„é€ å‡½æ•°ä¸Šéƒ½æœ‰ä¸€ä¸ª `prototype` å±æ€§ï¼Œæ¥æŒ‡å‘å®ä¾‹åŒ–å¯¹è±¡çš„åŸå‹ï¼ŒåŒæ—¶`prototype.constructor`æŒ‡å›æ„é€ å‡½æ•°ï¼Œè¿™å°±æ˜¯åŸå‹
- åŸå‹é“¾

  - å½“è®¿é—®å®ä¾‹å¯¹è±¡ä¸Šçš„å±æ€§æ—¶ï¼Œä¼šæ£€æµ‹å®ä¾‹å¯¹è±¡ä¸Šæœ‰æ²¡æœ‰è¯¥å±æ€§ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ä¼šé€šè¿‡å®ä¾‹å¯¹è±¡ä¸Šçš„`__proto__`å±æ€§ï¼Œä» prototype ä¸Šå»æŸ¥æ‰¾ï¼Œå¦‚æœå®ä¾‹å¯¹è±¡çš„åŸå‹`prototype`ä¸Šä¹Ÿæ²¡æœ‰è¯¥å±æ€§ï¼Œä¼šç»§ç»­ä»`prototypeçš„__proto__`ä¸Šå±‚å±‚æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ° Object æ„é€ å‡½æ•°çš„`prototype`ä¸Šï¼Œå¦‚æœæ²¡æœ‰çš„è¯ç»§ç»­é€šè¿‡`__proto__`æŸ¥æ‰¾ï¼Œç›´åˆ° nullï¼Œè¿™å°±æ˜¯åŸå‹é“¾

- ![alt text](åŸå‹.png)

## ä½œç”¨åŸŸ

- é™æ€ä½œç”¨åŸŸï¼ˆå®šä¹‰æ—¶ï¼‰ åŠ¨æ€ä½œç”¨åŸŸï¼ˆè°ƒç”¨æ—¶ï¼‰
- ä»€ä¹ˆæ˜¯ä½œç”¨åŸŸ
  - æºä»£ç èƒ½å®šä¹‰å˜é‡çš„åŒºåŸŸ

## æ‰§è¡Œä¸Šä¸‹æ–‡

```js
// demo1
var foo = function () {
  console.log('foo1')
}
foo()
var foo = function () {
  console.log('foo2')
}
foo()
// foo1
// foo2

// demo2
function foo() {
  console.log('foo1')
}
foo()
function foo() {
  console.log('foo2')
}
foo()
// foo2
// foo2

// demo3
console.log(add2(1, 2))
function add2(a, b) {
  return a + b
}
console.log(add1(1, 2))
var add1 = function (a, b) {
  return a + b
}
// 3 æŠ¥é”™(add1 is not a function)
```

- execute code

  - å…¨å±€ä»£ç 
  - å‡½æ•°ä»£ç 

### æ‰§è¡Œä¸Šä¸‹æ–‡æ ˆ

- execution context stack ECS

```js
ECStrack = [globalContext]
```

## é—­åŒ…

- èƒ½å¤Ÿè®¿é—®åˆ°è‡ªç”±å˜é‡çš„å‡½æ•°
- æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„ä¸¤å¤§æ¦‚å¿µï¼š

  1. ä½œç”¨äºé“¾
  2. å˜é‡å¯¹è±¡

- ä¼˜ç‚¹: å±æ€§è·å–æ–¹å¼ä¾¿æ·
- ç¼ºç‚¹ï¼šå› ä¸ºå¤ªä¾¿æ·ï¼Œä¸èƒ½æ˜ç¡®åˆ¤æ–­å˜é‡æ˜¯å¦åœ¨ç”¨ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´å¯èƒ½ä¸ä¼šè¢«å›æ”¶

## å‚æ•°ä¼ é€’

- æŒ‰å€¼ä¼ é€’
- æŒ‰å¼•ç”¨ä¼ é€’
  - æŒ‡é’ˆä¼ é€’

## callã€applyã€bind

```js
// åœ¨ä½¿ç”¨ä¸€ä¸ªæŒ‡å®šçš„ this å€¼å’Œè‹¥å¹²ä¸ªæŒ‡å®šçš„å‚æ•°å€¼çš„å‰æä¸‹è°ƒç”¨æŸä¸ªå‡½æ•°æˆ–æ–¹æ³•ã€‚
// call: æ”¹å˜thisæŒ‡å‘ï¼Œå¯ä»¥ä¼ é€’å¤šä¸ªå‚æ•°ï¼Œä¸ä¼ é€’thisæ—¶é»˜è®¤æŒ‡å‘window
// apply: æ”¹å˜thisæŒ‡å‘ï¼Œä¼ é€’ä¸€ä¸ªæ•°ç»„
// bind: è¿”å›ä¸€ä¸ªæ”¹å˜thisæŒ‡å‘åçš„å‡½æ•°ï¼Œä¸”æ°¸ä¹…æ”¹å˜thisæŒ‡å‘
fn.call(this, arg1, arg2)
const obj = {
  value: 1
}
const bar = function () {}
Function.prototype.call2 = function (context) {
  let context = context || window
  const args = [...arguments].slice(1)
  const symbol = Symbol()
  context[symbol] = this
  const results = context[symbol](...args)
  delete context[symbol]
  return results
}
fn.apply(this, ['1', '2'])

Function.prototype.apply = function (context, args) {
  let context = context || window
  const symbol = Symbol()
  context[symbol] = this
  const results = context[symbol](...args)
  delete context[symbol]
  return results
}

Function.prototype.bind2 = function (context, ...args) {
  let _this = this

  let fNOP = function () {}
  const fBound =  function (...returnArgs) {
    _this.apply(this instanceOf fBound ? this: context, [...args, ...returnArgs])
  }
  fNOP.prototype = this.prototype
  fBound.prototype = new fNOP()
  return fBound
}
```

## new

1. è¿”å›å¯¹è±¡ï¼Œè¿”å›æ„é€ å‡½æ•° prototype ä¸Šçš„å±æ€§

```javascript
function objectFactory() {
  const obj = new Object()
  let Constructor = [].shift.call(arguments)

  obj.__proto__ = Constructor.prototype

  const result = Constructor.apply(this, arguments)
  return typeof result === 'object' ? result : obj
}
```

## promise

### basic

```javascript
// basic
class MyPromise {
  constructor(executor) {
    this.status = 'pending'
    this.value = undefined

    const resolve = (value) => {
      if (this.status === 'pending') {
        this.status = 'resolved'
        this.value = value
      }
    }
    const reject = (error) => {
      if (this.status === 'pending') {
        this.status = 'rejected'
        this.value = error
      }
    }
    try {
      executor(resolve, reject)
    } catch (error) {
      reject(error)
    }
  }
}
```

### then

```javascript
class MyPromise {
  constructor(executor) {
    this.status = 'pending'
    this.value = undefined
    this.onFulfilledCallbacks = []
    this.onRejectedCallbacks = []

    const resolve = (value) => {
      if (this.status === 'pending') {
        this.status = 'fulfilled'
        this.value = value

        while (this.onFulfilledCallbacks.length > 0) {
          this.onFulfilledCallbacks.shift()(this.value)
        }
      }
    }

    const reject = (error) => {
      if (this.status === 'pending') {
        this.status = 'rejected'
        this.value = error

        while (this.onRejectedCallbacks.length) {
          this.onRejectedCallbacks.shift()(this.value)
        }
      }
    }

    executor(resolve, reject)
  }

  // é“¾å¼è°ƒç”¨
  // ä¸¤ä¸ªcallback
  // å®šæ—¶å™¨
  then(onFulfilled, onRejected) {
    // ç¡®ä¿ä¸ºå‡½æ•°
    typeof onFulfilled === 'function' ? onFulfilled : (val) => val
    typeof onRejected === 'function' ? onRejected : (val) => val

    const resolvePromise = new MyPromise((resolve, reject) => {
      const fn = (cb) => {
        let cbResult = cb(this.value)
        if (cbResult instanceof MyPromise) {
          cbResult.then(resolve, reject)
        } else {
          resolve(cbResult)
        }
      }

      if (this.status === 'fulfilled') {
        fn(onFulfilled)
      } else if (this.status === 'rejected') {
        fn(onRejected)
      } else if (this.status === 'pending') {
        this.onFulfilledCallbacks.push(() => fn(onFulfilled))
        this.onRejectedCallbacks.push(() => fn(onRejected))
      }
    })
    return resolvePromise

    // return resolvePromise
    // if (this.status === 'fulfilled') {
    //   onFulfilled(this.value)
    // } else if (this.status === 'rejected') {
    //   onRejected(this.value)
    // } else if (this.status === 'pending') {
    //   this.onFulfilledCallbacks.push(onFulfilled)
    //   this.onRejectedCallbacks.push(onRejected)
    // }
  }
}

const test2 = new MyPromise((resolve, reject) => {
  setTimeout(() => {
    resolve('success') // 1ç§’åè¾“å‡º success
  }, 1000)
}).then(
  (res) => console.log(res),
  (err) => console.log(err)
)

// é“¾å¼è°ƒç”¨ è¾“å‡º 200
const p3 = new Promise((resolve, reject) => {
  resolve(100)
})
  .then(
    (res) => 2 * res,
    (err) => console.log(err)
  )
  .then(
    (res) => console.log(res),
    (err) => console.log(err)
  )

// é“¾å¼è°ƒç”¨ è¾“å‡º300
const p4 = new Promise((resolve, reject) => {
  resolve(100)
})
  .then(
    (res) => new Promise((resolve, reject) => resolve(3 * res)),
    (err) => console.log(err)
  )
  .then(
    (res) => console.log(res),
    (err) => console.log(err)
  )

// console.log('ğŸš€ ~ p1 ~ p1:', p1)
```

### all

```javascript
const all = () => {
  const promiseList = []
  let count = 0
  return new MyPromise((resolve, reject) => {
    const addData = (res, index) => {
      promiseList[index] = res
      count++
      if (index === promiseList.length) {
        resolve(promiseList)
      }
    }
    promiseList.forEach((promise, index) => {
      if (promise instanceof MyPromise) {
        promise.then(
          (res) => {
            addData(res, index)
          },
          (err) => reject(err)
        )
      } else {
        addData(promise, index)
      }
    })
  })
}
```

### race

```javascript
const race = (promiseList) => {
  return new MyPromise((resolve, reject) => {
    promiseList.forEach((promise, index) => {
      if (promise instanceof MyPromise) {
        promise.then(
          (res) => {
            resolve(res)
          },
          (err) => reject(err)
        )
      } else {
        resolve(promise)
      }
    })
  })
}
```

### allSettled

- æˆåŠŸè®°å½•æˆåŠŸçš„ç»“æœ å¤±è´¥è®°å½•å¤±è´¥çš„ç»“æœ

```javascript
const allSettled = (promiseList) => {
  return new MyPromise((resolve, reject) => {
    let result = []
    let count = 0

    const addData = (value, index, status) => {
      result[index] = {
        status,
        value
      }
      count++
      if (count === result.length) {
        resolve(result)
      }
    }
    promiseList.forEach((promise, index) => {
      if (promise instanceof MyPromise) {
        promise.then(
          (res) => {
            addData(res, index, 'fulfilled')
          },
          (err) => {
            addData(err, index, 'rejected')
          }
        )
      } else {
        addData(promise, index, 'fulfilled')
      }
    })
  })
}
```

### any

- ä»»æ„ä¸€ä¸ªæˆåŠŸå°±è¿”å›æˆåŠŸ

```javascript
const any = (promiseList) => {
  return new Promise((resolve, reject) => {
    let count = 0
    promiseList.forEach((promise, index) => {
      if (promise instanceof MyPromise) {
        promise.then(
          (res) => {
            resolve(res)
          },
          (err) => {
            count++
            if (count === promiseList.length) {
              reject(err)
            }
          }
        )
      }
    })
  })
}
```

### async await

### generator

```javascript
// yield æš‚åœç‚¹ èƒ½å¤Ÿæä¾›æš‚åœçš„èƒ½åŠ›
function* gen() {
  yield 1
  yield 2
  yield 3
}
let g = gen()
console.log(g.next()) // { value: 1, done: false }
console.log(g.next()) // { value: 2, done: false }
console.log(g.next()) // { value: 3, done: false }
console.log(g.next()) // { value: undefined, done: true }
```
