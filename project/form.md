## 大型表单的控制

<!-- 实现表单数据的同步与状态保持 -->

### 背景

项目内涉及到了很多的表单，需要用户填写，由于表单项涉及到的表单项比较多，填写的时间比较长，再加上还有多标签页多窗口的操作，所以就遇到了一些问题

1. 数据丢失： 浏览器误关闭 刷新 导致数据丢死后
2. 数据恢复： 在未提交表单时，重新打开恢复之前填写的内容
3. 跨标签页通信： 在多个标签页同时编辑一个表单时，确保不同标签页的数据同步，避免数据不一致
4. 本地冗余数据问题

拿到需求梳理后就是两个模块

1. 数据自动保存与恢复
2. 多标签页通信

### 解决思路

将核心功能逻辑抽离，封装为公共模块，同时在 vue、react 中使用

设计成一个类的结构，内部代码不使用 框架特定的 API

##### 技术描述

1. 抽离一个类，实现

   1. 将当前表单数据保存到 localStorage
   2. 从 localStorage 加载数据并同步表单数据
   3. 通过 BroadcastChannel 广播数据
   4. 清楚本地数据
   5. 细节处理

2. 发布准备

   使用 rollup 压缩

   1. Tree Shaking 自动去除未使用的代码。能确保打包后的代码尽可能的小，从而提升加载性能和效率
   2. 输出格式多样。CommonJs、ESN、UMD。可以运行在不同的环境中(node、浏览器、模块打包器)中使用，增加了兼容性和灵活性
   3. 插件系统。rollup 提供了丰富的插件生态系统，可以方便的进行代码转换、压缩、文件处理等操作。如 `@rollup/plugin-node-resolve` `@rollup/plugin-commonjs` 插件来处理模块解析和转换，并使用 rollup-plugin-terser 对代码进行压缩，保证生成的体积包尽可能的小

#### 技术实现

类的功能模块

- FormStorage

  - 数据本地存储、恢复、删除

  - 多标签通信

- FormStorageManager
  - 管理 FormStorage 类实例
    - 集中管理: 确保所有实例统一初始化、数据保存和事件处理
    - 优化事件监听: 避免每个 FormStorage 实例中重复绑定全局事件监听器，减少不必要的开销
  - BroadcastChannel 实现跨标签页通信，也算是观察者模式的体现

本次存储

- localStorage： 同步存储，浏览器关闭后数据仍然存在，但是只能存储字符串的数据

- sessionStorage: 类似 localStorage 但浏览器关闭后会清空

- indexDB: 异步存储，支持更复杂的数据结构，比如对象，存储空间大

- 项目存储的是 表单控件的值，数据量不大，还需要回显，所以使用 localStorage

跨标签页通信方式对比

- localstorage storage 事件

  兼容性好

  只能在同源页面之间通信，数据只能是字符串的类型。 只能在不同标签页内生效，同一标签页不能触发

- services worker

  复杂逻辑的支持，离线处理，网络请求的拦截等

  实现复杂，还需要 https 支持，初次设置和调试成本较高

- postMessage

  支持跨域通信，可以在不同的源页面间通信

  需要手动管理消息的接受和处理，适合窗口间或 iframe 间的通信，标签页需要通过父窗口代理

- BroadcastChannel

  iframe 和窗口间通信不受影响，不受同源策略的限制

  兼容性不太好，不支持旧版浏览器（可以使用 localStorage 和 storage 方案）
